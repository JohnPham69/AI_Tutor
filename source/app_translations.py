import streamlit as st

# Original TRANSLATIONS (merged from test.py)
TRANSLATIONS = {
    "en": {
        "No lesson": "No lesson selected",
        "INCORRECT": "INCORRECT",
        "ERROR": "ERROR",
        "Tutor AI": "Tutor",
        "Practice / Quiz": "Practice / Quiz",
        "Failed to load lesson data: ": "Failed to load lesson data: ",
        "Config": "Config",
        "API Key": "API Key",
        "Enter your API key here": "Enter your API key here",
        "Save": "Save",
        "API key saved successfully!": "API key saved successfully!",
        "Please enter an API key!!!": "Please enter an API key!!!",
        "Adjust Context": "Lessons",
        "Grade?": "Grade?",
        "Textbook Set?": "Textbook Set?",
        "Subject?": "Subject?",
        "Lesson(s)?": "Lesson(s)?",
        "Choose lesson(s)": "Choose lesson(s)",
        "No lessons available": "No lessons available",
        "Upload Files for Context": "Upload Files for Context",
        "Select file (e.g., .txt, .pptx, .pdf, .docx)": "Select file (e.g., .txt, .pptx, .pdf, .docx)",
        "Processing: ": "Processing: ",
        "MarkItDown error for ": "MarkItDown error for ",
        "Error reading/preparing ": "Error reading/preparing ",
        "File processed and saved.": "File processed and saved.",
        "Could not retrieve file data.": "Could not retrieve file data.",
        "No file uploaded.": "No file uploaded.",
        "Select the language you desire.": "Select the language you desire.",
        "Practice Quiz Title": "Practice Quiz",
        "Start New Practice Session": "### Start a New Practice Session",
        "Start Quiz Button": "Start Quiz",
        "Based on Sidebar Selection": "Based on the subject and lesson selected in the sidebar (if any).",
        "Configure Your Quiz": "### Configure Your Quiz",
        "Number of Questions Prompt": "How many questions do you want to answer?",
        "Time Limit Prompt (minutes)": "How long do you want to answer (minutes)?",
        "Time Per Question Info": "**Time per question:** {time_per_question:.0f} seconds",
        "Create Quiz and Start Button": "Create Quiz and Start",
        "API Key Missing Error Config": "Please enter your API key in Config or the sidebar.",
        "Creating Quiz Spinner": "Creating quiz...",
        "Not Enough Questions Error": "Could not generate enough questions. Check API or network connection.",
        "Go Back Button": "Go Back",
        "Quiz Completed Message": "You have completed the quiz!",
        "Result Info": "**Result:** {correct}/{total} correct",
        "Add to Leaderboards": "Add to Leaderboards",
        "Question Number Info": "### Question {current_idx_plus_1} / {total_questions}",
        "Your Answer Label": "Your answer:",
        "Time Remaining Label": "⌛Time remaining (seconds):",
        "Check Answer Button": "Check",
        "API Key Missing In-Quiz Error": "Missing API key.",
        "Grading Spinner": "Grading...",
        "Correct Feedback Message": "Correct! ✅",
        "Incorrect Feedback Message": "Incorrect! ❌ The correct answer is: {correct_answer}",
        "Error Grading Feedback Message": "Error grading. The correct answer is: {correct_answer}",
        "Exit Quiz Button": "Exit Quiz",
        "Continue Button": "Continue",
        "No messages yet. Start a conversation!": "No messages yet. Start a conversation!",
        "Enter your model name here": "Enter your model name here",
        "Enter your nickname here": "Enter your nickname here",
        "Enter your model name here": "Enter your model name here",
        "Enter your school name here": "Enter your school name here",
        "Enter your class here": "Enter your class here",
        "Enter your Student ID here": "Enter your Student ID here",
        "Save results": "Save results",
        "You must finish the quiz.": "You must finish the quiz.",
        "Nothing to save.": "Nothing to save.",
        "Results saved.": "Results saved.",
        "Save your own results!": "Save your own results!",
        "Total Questions Attempted: {}": "Total Questions Attempted: {}",
        "Total Correct Answers: {}": "Total Correct Answers: {}",
        "View Lesson Button": "View Lesson",
        "N/A": "N/A",
        "Please fill in your Nickname, School, Class, and Student ID in the sidebar to save results.": "Please fill in your Nickname, School, Class, and Student ID in the sidebar to save results.",
        "View lessons selected in the sidebar": "View lessons selected below",
        "Select all lessons": "Select all lessons",
        "Learning with AI": "Learning",
        "Type your message here (/x to clear, attach TXT/PPTX/PDF/DOCX if needed)": "Type your message here (/x for new chat)",
        "Lỗi cấu hình: Google Sheets credentials không được thiết lập trong Streamlit secrets.": "Configuration error: Google Sheets credentials were not established in Streamlit secrets",
    },
    "vi": {
        "No lesson": "Không chọn bài học",
        "INCORRECT": "SAI",
        "ERROR": "LỖI",
        "Tutor AI": "Trả bài",
        "Practice / Quiz": "Luyện tập / Trắc nghiệm",
        "Failed to load lesson data: ": "Lỗi tải dữ liệu bài học: ",
        "Config": "Cấu hình",
        "API Key": "Khóa API",
        "Enter your API key here": "Nhập API key của bạn ở đây",
        "Save": "Lưu",
        "API key saved successfully!": "Đã lưu API key thành công!",
        "Please enter an API key!!!": "Vui lòng nhập API key!!!",
        "Adjust Context": "Bài học",
        "Grade?": "Khối ?",
        "Textbook Set?": "Bộ SGK?",
        "Subject?": "Môn học?",
        "Lesson(s)?": "Bài học?",
        "Choose lesson(s)": "Chọn (các) bài học",
        "No lessons available": "Không có bài học",
        "Upload Files for Context": "Tải tệp cho ngữ cảnh",
        "Select file (e.g., .txt, .pptx, .pdf, .docx)": "Chọn tệp (ví dụ: .txt, .pptx, .pdf, .docx)",
        "Processing: ": "Đang xử lý: ",
        "MarkItDown error for ": "Lỗi MarkItDown cho ",
        "Error reading/preparing ": "Lỗi đọc/chuẩn bị ",
        "File processed and saved.": "Tệp đã xử lý và lưu.",
        "Could not retrieve file data.": "Không thể lấy dữ liệu tệp.",
        "No file uploaded.": "Không có tệp nào được tải lên.",
        "Select the language you desire.": "Chọn ngôn ngữ bạn muốn.",
        "Practice Quiz Title": "Luyện tập",
        "Start New Practice Session": "### Bắt đầu một phiên luyện tập mới",
        "Start Quiz Button": "Tạo bài luyện tập",
        "Based on Sidebar Selection": "Dựa trên môn học và bài học đã chọn ở thanh bên (nếu có).",
        "Configure Your Quiz": "### Cấu hình Bài Quiz của Bạn",
        "Number of Questions Prompt": "Bạn muốn trả lời bao nhiêu câu?",
        "Time Limit Prompt (minutes)": "Bạn muốn trả lời trong bao nhiêu phút?",
        "Time Per Question Info": "**Thời gian cho mỗi câu hỏi:** {time_per_question:.0f} giây",
        "Create Quiz and Start Button": "Tạo Quiz và Bắt đầu",
        "API Key Missing Error Config": "Vui lòng nhập API key ở mục Config hoặc thanh bên.",
        "Creating Quiz Spinner": "Đang tạo quiz...",
        "Not Enough Questions Error": "Không thể tạo đủ câu hỏi. Kiểm tra API hoặc kết nối mạng.",
        "Go Back Button": "Quay lại",
        "Quiz Completed Message": "Bạn đã hoàn thành bài quiz!",
        "Result Info": "**Kết quả:** {correct}/{total} đúng",
        "Add to Leaderboards": "Thêm vào Bảng xếp hạng",
        "Question Number Info": "### Câu hỏi {current_idx_plus_1} / {total_questions}",
        "Your Answer Label": "Câu trả lời của bạn:",
        "Time Remaining Label": "⌛Thời gian còn lại (giây):",
        "Check Answer Button": "Kiểm tra",
        "API Key Missing In-Quiz Error": "Thiếu API key.",
        "Grading Spinner": "Đang chấm điểm...",
        "Correct Feedback Message": "Đúng rồi! ✅",
        "Incorrect Feedback Message": "Sai rồi! ❌ Đáp án đúng là: {correct_answer}",
        "Error Grading Feedback Message": "Lỗi khi chấm điểm. Đáp án đúng là: {correct_answer}",
        "Exit Quiz Button": "Thoát Quiz",
        "Continue Button": "Tiếp tục",
        "No messages yet. Start a conversation!": "Chưa có tin nhắn. Hãy bắt đầu cuộc trò chuyện!",
        "Enter your model name here": "Nhập tên mô hình của bạn ở đây",
        "Enter your nickname here": "Nhập biệt danh của bạn ở đây",
        "Enter your model name here": "Nhập tên mô hình của bạn ở đây", 
        "Enter your school name here": "Nhập tên trường của bạn ở đây",
        "Enter your class here": "Nhập lớp của bạn ở đây",
        "Enter your Student ID here": "Nhập ID học sinh của bạn ở đây",
        "Save results": "Lưu kết quả",
        "You must finish the quiz.": "Bạn phải hoàn thành bài kiểm tra.",
        "Nothing to save.": "Không có gì để lưu.",
        "Results saved.": "Đã lưu kết quả.",
        "Save your own results!": "Lưu kết quả của riêng bạn!",
        "Total Questions Attempted: {}": "Tổng số câu đã thử: {}",
        "Total Correct Answers: {}": "Tổng số câu trả lời đúng: {}",
        "View Lesson Button": "Xem bài học",
        "N/A": "Không áp dụng",
        "Please fill in your Nickname, School, Class, and Student ID in the sidebar to save results.": "Vui lòng điền Biệt danh, Trường, Lớp và Mã số sinh viên của bạn vào thanh bên để lưu kết quả.",
        "View lessons selected in the sidebar": "Xem các bài học đã chọn bên trên",
        "Select all lessons": "Chọn tất cả bài học",
        "API key not configured, please set it in the Config page.": "API key chưa được cấu hình, vui lòng cài đặt trong trang Cấu hình.",
        "An error occurred while processing your request.": "Đã xảy ra lỗi trong quá trình xử lý yêu cầu của bạn.",
        "Expand": "Mở rộng",
        "Navigation": "Chọn chức năng",
        "Leaderboard": "Xếp hạng",
        "Timer": "Đồng hồ",
        "Top Performers": "Những người xuất sắc nhất",
        "Leaderboard is currently empty or could not be loaded.": "Bảng xếp hạng hiện đang trống hoặc không thể tải.",
        "Buy me a coffee?": "Tặng tôi một ly cà phê?",
        "Here's my donation link: ABCDEFGHIJKLMNOPQRSTUVWXYZ": "Gửi vào STK: ABCDEFGHIJKLMNOPQRSTUVWXYZ", # Replace with actual link or QR code if needed
        "Donate": "Donate",
        "Type of Question Prompt": "Loại câu hỏi?",
        "Multiple Choice": "Trắc nghiệm",
        "Long / Short Answer": "Trả lời dài / ngắn",
        "Mixed": "Hỗn hợp",
        "Learning with AI": "Hỏi bài",
        "Donation information:": "Thông tin ủng hộ:",
        "ACB (Asia Commercial Joint Stock Bank)": "ACB (Ngân hàng Thương mại Cổ phần Á Châu)",
        "Through": "Thông qua",
        "Type your message here (/x to clear, attach TXT/PPTX/PDF/DOCX if needed)": "Nhập tin nhắn của bạn ở đây (/x để tạo mới)",
        "<p style='text-align:center; color:grey;'>No messages yet.</p>": "<p style='text-align:center; color:grey;'>Chưa có tin nhắn.</p>",
        "No subjects available": "Không có môn học nào",
        "Study": "Học tập",
        "Practice": "Luyện tập",
        "Choose grade": "Chọn khối",
        "Choose textbook set": "Chọn bộ sách giáo khoa",
        "Grade": "Lớp",
        "Set": "Bộ sách",
        "Lesson": "Bài",
        "No subject or lesson selected from the sidebar. The quiz will cover general knowledge topics.": "Không có môn học hoặc bài học nào được chọn từ thanh bên. Bài quiz sẽ bao gồm các chủ đề kiến thức chung.",
        "A lesson (ID: {lesson_id}) was selected, but its content URL could not be found. The quiz may cover general topics for subject '{subject_name}'. Please check sidebar selections and data integrity.": "Bài học (ID: {lesson_id}) đã được chọn, nhưng URL nội dung không thể tìm thấy. Bài quiz có thể bao gồm các chủ đề chung cho môn '{subject_name}'. Vui lòng kiểm tra các lựa chọn ở thanh bên và tính toàn vẹn của dữ liệu.",
        "No specific lesson selected from the sidebar for subject '{subject_name}'. The quiz will cover general topics for this subject.": "Không có bài học cụ thể nào được chọn từ thanh bên cho môn '{subject_name}'. Bài quiz sẽ bao gồm các chủ đề chung cho môn này.",
        "A lesson is selected, but the subject is missing. Please check sidebar selections. The quiz may cover general knowledge topics.": "Một bài học đã được chọn, nhưng môn học bị thiếu. Vui lòng kiểm tra các lựa chọn ở thanh bên. Bài quiz có thể bao gồm các chủ đề kiến thức chung.",
        "How to": "API Key?",
        "FAQ - Frequently Asked Question": "FAQ - Câu hỏi thường gặp",
        "Please enter your API key!!!": "Bạn cần nhập API key!!!", 
        "AI is thinking...": "AI đang suy nghĩ...",
        "Error in AddNewResult: 'gcp_service_account' not found in st.secrets.": "Lỗi trong AddNewResult: 'gcp_service_account' không thể tìm được trong st.secrets.",
        "Funny": "Hài hước",
        "Advance": "Nâng cao",
        "Shall we start?": "Chúng ta bắt đầu nhé"
    }
}

def init_session_language():
    """Initializes language in session_state if not present. Call once in main app."""
    if 'lang' not in st.session_state:
        st.session_state.lang = 'vi' # Default to Vietnamese
    if 'changeLang' not in st.session_state:
        st.session_state.changeLang = False

def get_translator():
    # Assumes init_session_language() has been called.
    current_lang = st.session_state.get('lang', 'vi') # Default to 'vi' if somehow not set
    def translate(key):
        return TRANSLATIONS.get(current_lang, {}).get(key, TRANSLATIONS.get("en", {}).get(key, key))
    return translate
